pipeline {
    agent { label 'ubuntu-docker' }

    environment { 
        PROJECTNAME = 'my_web_blog'
        DOCKERNAME = 'soloma70'
    }

    triggers { pollSCM('2 * * * *') }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
        timestamps()
    }

    stages {

        stage('Delete workspace before build starts') {
            steps {
                echo 'Deleting workspace'
                deleteDir()
            }
        }
        
        stage('Checkout') {
            steps{
                git branch: 'master',
                    url: 'https://github.com/soloma70/my_site.git/'        
                }
        }
        
        stage('Test') {
            steps{
                sh 'ls -la'
                sh 'pwd'
            }
        }
        
        stage("Login to DockerHub") {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-soloma', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh 'docker login -u $USERNAME -p $PASSWORD'
                }
            }
        }

        stage('Build Docker image') {
            steps{
                sh '''
                docker build -t $DOCKERNAME/$PROJECTNAME:v1.${BUILD_NUMBER} .
                docker tag $DOCKERNAME/$PROJECTNAME:v1.${BUILD_NUMBER} $DOCKERNAME/$PROJECTNAME:latest
                docker images
                '''
            }
        }
        
        stage('Push Docker image to DockerHub') {
            steps{
                sh '''
                docker push $DOCKERNAME/$PROJECTNAME:v1.${BUILD_NUMBER}
                docker push $DOCKERNAME/$PROJECTNAME:latest
                '''
            }
        }
        
        stage('Delete Docker image locally') {
            steps{
                sh 'docker rmi -f $(docker images -q $DOCKERNAME/$PROJECTNAME)'
                sh 'docker images'
            }
        }
    }
}